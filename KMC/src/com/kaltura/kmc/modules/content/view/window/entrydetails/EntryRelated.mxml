<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" implements="com.kaltura.kmc.modules.content.business.IDrilldownPanel"
		 width="100%" height="100%">
	<mx:Script>
		<![CDATA[
			import com.kaltura.kmc.modules.content.events.RelatedFileEvent;
			import com.kaltura.kmc.modules.content.view.window.entrydetails.renderers.relatedFiles.RelatedFileActionRenderer;
			import com.kaltura.kmc.modules.content.vo.RelatedFileVO;
			import com.kaltura.vo.KalturaAttachmentAsset;
			import com.kaltura.vo.KalturaBaseEntry;
			
			import mx.collections.ArrayCollection;
			
			public static const ALLOWED_EXT:String = "*.*";
			
			//will be used to convert size to KB
			private const KB_MULTIPLIER:int = 1024;
			//in files size: number of digits to show after the decimal point
			private const DIGITS_AFTER_DEC_POINT:int = 2;
			
			//list of related files
			private var _relatedFiles:ArrayCollection;
			public var selectedEntry:KalturaBaseEntry;
			private var _fileReference:FileReference;

			[Bindable]
			/**
			 * related files of current entry
			 * */
			public function get relatedFiles():ArrayCollection
			{
				return _relatedFiles;
			}

			public function set relatedFiles(value:ArrayCollection):void
			{
				_relatedFiles = value;
			}

			/**
			 * get relevant data from server
			 * */
			public function initData():void {
				var list:RelatedFileEvent = new RelatedFileEvent(RelatedFileEvent.LIST_RELATED_FILES);
				list.dispatch();
			}
			
			public function destroy():void {
				
			}

			/**
			 * Open browse window and adds the selected file to the related files
			 * */
			protected function addFile(event:MouseEvent):void
			{
				_fileReference = new FileReference();
				_fileReference.addEventListener(Event.SELECT, onFileSelected);
				_fileReference.browse(new Array(new FileFilter(resourceManager.getString('cms','files') +' (' + ALLOWED_EXT + ')' ,ALLOWED_EXT)));
			}
			
			private function onFileSelected(event:Event):void {
				_fileReference.removeEventListener(Event.SELECT, onFileSelected);
				var newRelated:RelatedFileVO = new RelatedFileVO();
				newRelated.file = new KalturaAttachmentAsset();
				newRelated.fileReference = _fileReference;
				_relatedFiles.addItemAt(newRelated, 0);
				
			}
			
			/**
			 * Create suitable string to display in the "File Size" column
			 * */
			private function fileSizeLabelFunc(item:Object, column:DataGridColumn): String {
				var curItem:RelatedFileVO = item as RelatedFileVO;
				var size:int;
				if (curItem.fileReference)
					size = curItem.fileReference.size;
				else
					size = curItem.file.size;
				
				if (size==int.MIN_VALUE)
					return '';
				return ((size/KB_MULTIPLIER).toFixed(DIGITS_AFTER_DEC_POINT)) + ' ' + resourceManager.getString('cms','kiloBytes');
				
			}

		]]>
	</mx:Script>
	<mx:Button label="{resourceManager.getString('cms','addFiles')}" click="addFile(event)"/>
	<mx:DataGrid dataProvider="{relatedFiles}" width="100%" height="100%">
		<mx:columns>
			<mx:DataGridColumn headerText="{resourceManager.getString('cms','fileName')}">
				<mx:itemRenderer>
					<mx:Component>
						<mx:VBox paddingLeft="5" paddingRight="5" width="100%" height="100%" horizontalScrollPolicy="off">
							<mx:TextInput text="{data.file.filename}" width="100%"/>
						</mx:VBox>
					</mx:Component>
				</mx:itemRenderer>
			</mx:DataGridColumn>
			<mx:DataGridColumn headerText="{resourceManager.getString('cms','fileType')}">
				<mx:itemRenderer>
					<mx:Component>
						<mx:VBox paddingLeft="5">
							<mx:ComboBox dataProvider="{new Array(resourceManager.getString('cms','document'), resourceManager.getString('cms','media'))}" selectedIndex="-1" 
										 prompt="{resourceManager.getString('cms','selectType')}"/>
							
						</mx:VBox>				
					</mx:Component>
				</mx:itemRenderer>
			</mx:DataGridColumn>
			<mx:DataGridColumn headerText="{resourceManager.getString('cms','fileSize')}" labelFunction="{fileSizeLabelFunc}"/>
			<mx:DataGridColumn headerText="{resourceManager.getString('cms','kalturaId')}">
				<mx:itemRenderer>
					<mx:Component>
						<mx:VBox paddingLeft="6">
							<mx:Label text="{data.file.id}"/>
						</mx:VBox>
					</mx:Component>
				</mx:itemRenderer>
			</mx:DataGridColumn>
			<mx:DataGridColumn headerText="{resourceManager.getString('cms','actions')}" itemRenderer="com.kaltura.kmc.modules.content.view.window.entrydetails.renderers.relatedFiles.RelatedFileActionRenderer"/>
		</mx:columns>
	</mx:DataGrid>
</mx:VBox>
