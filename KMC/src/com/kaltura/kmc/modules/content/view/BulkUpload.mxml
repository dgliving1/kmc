<?xml version="1.0" encoding="utf-8"?>
<mx:VBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:navigation="com.kaltura.kmc.modules.content.view.navigation.*"
		 xmlns:controls="com.kaltura.controls.*" implements="com.kaltura.kmc.modules.content.view.content.IContentPanel"
		 horizontalAlign="left" width="100%" height="100%" 
		 creationComplete="{creationCompleteHandler(event)}">

	<mx:Script>
		<![CDATA[
			import com.kaltura.analytics.GoogleAnalyticsConsts;
			import com.kaltura.analytics.GoogleAnalyticsTracker;
			import com.kaltura.analytics.KAnalyticsTracker;
			import com.kaltura.analytics.KAnalyticsTrackerConsts;
			import com.kaltura.kmc.business.PermissionManager;
			import com.kaltura.kmc.modules.content.business.BulkFailedReasonTranslator;
			import com.kaltura.kmc.modules.content.events.BulkEvent;
			import com.kaltura.kmc.modules.content.model.BulkUploadModel;
			import com.kaltura.kmc.modules.content.model.types.BulkTypes;
			import com.kaltura.kmc.modules.content.view.controls.FileManager;
			import com.kaltura.kmc.modules.content.vo.FilterVO;
			import com.kaltura.types.KalturaStatsKmcEventType;
			import com.kaltura.utils.pager.Pager;
			import com.kaltura.vo.KalturaBaseEntryFilter;
			import com.kaltura.vo.KalturaBulkUpload;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.controls.CheckBox;
			import mx.controls.ComboBox;
			import mx.events.FlexEvent;
			import mx.formatters.DateFormatter;

			
			[Bindable]
			/**
			 * data that only bulkUpload tab uses
			 * */
			public var bulkUploadData:BulkUploadModel;
			
			[Bindable]
			public var bulkUploadEnabled : Boolean = true; 

//			[Bindable]
//			/**
//			 * Kaltura Session key, used with EI call.
//			 * */
//			public var ks:String;

			private var _pager:Pager;

			private var _fm:FileManager = new FileManager();


			private var _filter:FilterVO = new FilterVO();

//			private var _fileReadyFlag:Boolean = false;



			/**
			 * this panel does not support initial filtering data, the kmef param is ignored.
			 * @inheritDoc
			 * */
			public function init(kmef:KalturaBaseEntryFilter = null):void {
				
			}
			
//
//
//			private function setFileName(event:Event):void {
//				_fileReadyFlag = true;
//				var bulkEvent:BulkEvent = new BulkEvent(BulkEvent.ADD_BULK_UPLOAD, _filter, _fm);
//				bulkEvent.dispatch();
//			}


//			private function submitCSV():void {
//				if (_fileReadyFlag) {
//					var bulkEvent:BulkEvent = new BulkEvent(BulkEvent.ADD_BULK_UPLOAD, _filter, _fm);
//					bulkEvent.dispatch();
//					clearUpload();
//
//					KAnalyticsTracker.getInstance().sendEvent(KAnalyticsTrackerConsts.CONTENT, KalturaStatsKmcEventType.CONTENT_BULK_UPLOAD, "Upload>SubmitCSV");
//					GoogleAnalyticsTracker.getInstance().sendToGA(GoogleAnalyticsConsts.CONTENT_BULK_UPLOAD, GoogleAnalyticsConsts.CONTENT);
//				}
//				else
//					Alert.show(resourceManager.getString('cms', 'browseFirst'));
//			}

//
//
//			private function clearUpload():void {
//				_fileReadyFlag = false;
//			}

			public function initPaging():void {
				if (paging && _pager && _pager.allEntries)
					paging.totalCount = _pager.numPagesTotal * _pager.localPageSize;
			}


			/**
			 * load bulkuploads list
			 * */
			public function loadEntries():void {
				if (paging)
					_filter.page = paging.selectedPage;
				if (bulkUploadEnabled) {
					var bulkEvent:BulkEvent = new BulkEvent(BulkEvent.LIST_BULK_UPLOAD, _filter);
					bulkEvent.dispatch();
				}
			}

//
//			public function addBulk():void {
//				clearUpload();
//				_fm.fr = new FileReference();
//				_fm.fr.addEventListener(Event.SELECT, setFileName);
//				_fm.fr.browse(getTypes());
//			}


			private function getTypes():Array {
				var allTypes:Array = [new FileFilter("CSV Files (*.csv)", "*.csv")];
				return allTypes;
			}


			public function set pager(pager:Pager):void {
				_pager = pager;
				initPaging();
			}


			public function get pager():Pager {
				return _pager;
			}
			
			public function get allowActions():Boolean {
				return true;
			}
			
			public function set allowActions(value:Boolean):void {
				if (!value) {
					var ar:Array = bulkTable.columns;
					for (var i:int = 0; i<ar.length; i++) {
						if (ar[i] == actions) {
							ar.splice(i, 1);
							break;
						}
					}
					bulkTable.columns = ar;
				}
			}

			public function getStatus(status:String):String {
				return BulkTypes.getTypeName(uint(status));
			}


			public function getDate(fileObj:Object):String {
				var df:DateFormatter = new DateFormatter();
				df.formatString = resourceManager.getString('cms', 'listdateformat');
				var dt:Date = new Date();
				dt.setTime(Number(fileObj.uploadedOn) * 1000);
				return df.format(dt);
			}


			public function getEntriesNumber(fileObj:Object):String {
				return (fileObj.numOfEntries == int.MIN_VALUE) ? '' : (fileObj.numOfEntries + '');
			}



			public function downloadFile(filePath:String, fileNmae:String):void {
//				_fm.fr = new FileReference();
//				_fm.downloadFile(filePath, "Download", fileNmae);
				var request:URLRequest = new URLRequest(filePath);
				var fr:FileReference = new FileReference();
				fr.addEventListener(Event.CANCEL, downloadHandler);
				fr.addEventListener(Event.COMPLETE, downloadHandler);
				fr.addEventListener(IOErrorEvent.IO_ERROR, downloadHandler);
				fr.addEventListener(SecurityErrorEvent.SECURITY_ERROR, downloadHandler);
				fr.download(request, fileNmae);
			}
			
			private function downloadHandler(e:Event):void {
				e.target.removeEventListener(Event.CANCEL, downloadHandler);
				e.target.removeEventListener(Event.COMPLETE, downloadHandler);
				e.target.removeEventListener(IOErrorEvent.IO_ERROR, downloadHandler);
				e.target.removeEventListener(SecurityErrorEvent.SECURITY_ERROR, downloadHandler);
				if (e is IOErrorEvent || e is SecurityErrorEvent) {
					Alert.show(resourceManager.getString('cms', 'downloadFailed'));
				}
			}


			/**
			 * opens a file without separating path from name.
			 * @param url 	path to file.
			 * */
			private function downloadFileDirect(url:String):void {
				var req:URLRequest = new URLRequest(url);
				navigateToURL(req);
			}


			private function onPagerCreationComplete(event:Event):void {
				bulkUploadData.bulkUploadFilterPager = paging.kalturaFilterPager;
				paging.kalturaFilterPager.pageIndex = 0;
				paging.kalturaFilterPager.pageSize = paging.rowInPageCb.value as int;

			}


			private function gotoPage():void {
				paging.kalturaFilterPager.pageIndex = paging.selectedPage;
				GoogleAnalyticsTracker.getInstance().sendToGA(GoogleAnalyticsConsts.CONTENT_GO_TO_PAGE, GoogleAnalyticsConsts.CONTENT);
				KAnalyticsTracker.getInstance().sendEvent(KAnalyticsTrackerConsts.CONTENT, KalturaStatsKmcEventType.CONTENT_CONTENT_GO_TO_PAGE, "content>Show Rows");
				loadEntries();
			}


			protected function creationCompleteHandler(event:FlexEvent):void {
				PermissionManager.getInstance().applyAllAttributes(this, this.id);
				addEventListener("delete", handleBulkAction);
				addEventListener("dnldLog", handleBulkAction);
				addEventListener("dnldOrig", handleBulkAction);
				loadEntries();
			}
			
			protected function handleBulkAction(e:Event):void {
				var bulk:KalturaBulkUpload = e.target.data as KalturaBulkUpload;
				switch (e.type) {
//					case "delete":
//						break;
					case "dnldLog":
						downloadFile(bulk.logFileUrl,'logFile.csv');
//						downloadFileDirect(bulk.logFileUrl);
						break;
					case "dnldOrig":
						downloadFile(bulk.bulkFileUrl, 'origFile.' + getUploadType(bulk, null));
//						downloadFileDirect(bulk.bulkFileUrl);
						break;
				}
			}
			
			/**
			 * get uploader name to display.
			 * if no screen name (uploadedBy) use user id (uploadedByUserId)
			 * */
			protected function getScreenNameOrUserId(item:Object, column:DataGridColumn):String {
				if (item.uploadedBy) {
					return item.uploadedBy;
				}
				else return item.uploadedByUserId;
			}
			
			/**
			 * get upload type (csv / xml) by file extension
			 * */
			protected function getUploadType(item:Object, column:DataGridColumn):String {
				var url:String = item.bulkFileUrl;
				var i:int = url.lastIndexOf("/");
				var ext:String = url.substring(i+1);
				ext = ext.toLowerCase();
				var res:String = resourceManager.getString('cms', ext);
				if (res) {
					return res;
				}
				return ext;
			}
			
			private function getFailedReason (item:Object, column:DataGridColumn):String {
				return BulkFailedReasonTranslator.getReason(item as KalturaBulkUpload);
			}
		]]>
	</mx:Script>

		<mx:VBox id="bulkUploadBox" width="100%" height="100%" >
			<mx:Label text="{resourceManager.getString('cms', 'importFromExistingHosting')}" styleName="expendableButton" />
			<mx:Text htmlText="{resourceManager.getString('cms', 'importFromExistingHostingText')}" />
			
			<mx:VBox styleName="vGapBox" width="100%" height="100%">
				<mx:DataGrid id="bulkTable" width="100%" height="100%" sortableColumns="false"
							 dataProvider="{bulkUploadData.bulkUploads}" headerRelease="{event.preventDefault()}">
					<mx:columns>
						<!-- file type -->
						<mx:DataGridColumn width="50" labelFunction="getUploadType"
										   headerText="{resourceManager.getString('cms', 'uploadType')}" />
						
						<!-- uploaded by -->
						<mx:DataGridColumn width="50" labelFunction="getScreenNameOrUserId"
										   headerText="{resourceManager.getString('cms', 'uploadedBy')}"
										   showDataTips="true" dataTipField="uploadedBy"/>
						
						<!-- uploaded on -->
						<mx:DataGridColumn dataField="uploadedOn" width="60"
										   headerText="{resourceManager.getString('cms', 'uploadedOn')}"
										   showDataTips="true" dataTipField="uploadedOn">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label paddingLeft="7" text="{outerDocument.getDate(data)}" toolTip="{this.text}" />
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
						
						<!-- number of entries -->
						<mx:DataGridColumn dataField="numOfEntries" width="50"
										   headerText="{resourceManager.getString('cms', 'numOfEntries')}">
							<mx:itemRenderer>
								<mx:Component>
									<mx:HBox width="100%" horizontalAlign="center">
										<mx:Label id="entriesLabel" text="{outerDocument.getEntriesNumber(data)}" toolTip="{entriesLabel.text}" />
									</mx:HBox>
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
						
						<!-- status -->
						<mx:DataGridColumn width="60" headerText="{resourceManager.getString('cms', 'status')}">
							<mx:itemRenderer>
								<mx:Component>
									<mx:Label paddingLeft="7" text="{outerDocument.getStatus(data.status)}" toolTip="{this.text}" />
								</mx:Component>
							</mx:itemRenderer>
						</mx:DataGridColumn>
						
						<!-- error -->
						<mx:DataGridColumn dataField="error" width="100" labelFunction="getFailedReason"
										   headerText="{resourceManager.getString('cms', 'error')}" showDataTips="true"
										   dataTipField="error"/>
						
						<!-- actions -->
						<mx:DataGridColumn id="actions" width="100" 
										   itemRenderer="com.kaltura.kmc.modules.content.view.itemrenderers.uploads.LogActionsIR"
										   headerText="{resourceManager.getString('cms', 'action')}" />
						
					</mx:columns>
				</mx:DataGrid>
				<controls:Paging id="paging" width="100%" styleName="paging" rowsInPageChange="gotoPage()"
								 nextPage="gotoPage()" prvPage="gotoPage()" getPageNum="gotoPage()"
								 showRowsInPage="true" 
								 creationComplete="onPagerCreationComplete(event)"
								 totalCount="{bulkUploadData.bulkUploadTotalCount}"/>
		</mx:VBox>
	</mx:VBox>
</mx:VBox>
